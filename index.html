
<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    
    <!-- iOS PWA Settings -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="吉他課紀錄">
    <meta name="format-detection" content="telephone=no">
    
    <title>Guitar Class Tracker</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM (UMD) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel (for JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
      body {
        background-color: #f8fafc;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        overscroll-behavior-y: none;
        -webkit-tap-highlight-color: transparent;
      }
      .no-scrollbar::-webkit-scrollbar {
        display: none;
      }
      .no-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
      /* Animation Utilities */
      .animate-in {
        animation-duration: 0.2s;
        animation-fill-mode: both;
      }
      .fade-in {
        animation-name: fadeIn;
      }
      .slide-in-from-bottom-10 {
        animation-name: slideInFromBottom10;
      }
      .zoom-in {
        animation-name: zoomIn;
      }
      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }
      @keyframes slideInFromBottom10 {
        from { transform: translateY(2.5rem); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
      }
      @keyframes zoomIn {
        from { transform: scale(0.95); opacity: 0; }
        to { transform: scale(1); opacity: 1; }
      }
    </style>
  <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.3",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
    "react/": "https://esm.sh/react@^19.2.3/",
    "lucide-react": "https://esm.sh/lucide-react@^0.562.0"
  }
}
</script>
</head>
  <body>
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect, useRef } = React;
      const { createRoot } = ReactDOM;
      
      // --- INLINE ICONS ---
      const Icons = {
        Guitar: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m9 13-5-5"/><path d="m7 15 10-10"/><path d="m11 11-1.5 1.5a2.121 2.121 0 0 0 0 3l5 5a2.121 2.121 0 0 0 3 0l1.5-1.5a2.121 2.121 0 0 0 0-3l-5-5a2.121 2.121 0 0 0-3 0Z"/></svg>,
        Check: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M20 6 9 17l-5-5"/></svg>,
        Calendar: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>,
        CreditCard: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect width="20" height="14" x="2" y="5" rx="2"/><line x1="2" x2="22" y1="10" y2="10"/></svg>,
        User: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
        Trash2: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>,
        Banknote: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect width="20" height="12" x="2" y="6" rx="2"/><circle cx="12" cy="12" r="2"/><path d="M6 12h.01M18 12h.01"/></svg>,
        Settings: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>,
        X: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>,
        ChevronLeft: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m15 18-6-6 6-6"/></svg>,
        ChevronRight: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m9 18 6-6-6-6"/></svg>,
        AlertTriangle: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>,
        Plus: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M5 12h14"/><path d="M12 5v14"/></svg>,
        Clock: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
        Download: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>,
        Upload: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>,
        Edit: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>,
      };

      const Icon = ({ name, size = 24, className, ...props }) => {
        const Component = Icons[name];
        if (!Component) return <span style={{width:size, height:size, display:'inline-block', background:'#eee', borderRadius: '4px'}}></span>;
        return <Component width={size} height={size} className={className} {...props} />;
      };

      // --- UTILS ---
      const generateId = () => Math.random().toString(36).substr(2, 9);
      const formatDate = (dateString) => {
        const date = new Date(dateString);
        return new Intl.DateTimeFormat("zh-TW", { month: "numeric", day: "numeric" }).format(date);
      };
      const formatTime = (dateString) => {
        const date = new Date(dateString);
        return new Intl.DateTimeFormat("zh-TW", { hour: "2-digit", minute: "2-digit", hour12: false }).format(date);
      };
      const formatCurrency = (amount) => {
        return new Intl.NumberFormat("zh-TW", { style: "currency", currency: "TWD", minimumFractionDigits: 0 }).format(amount);
      };
      const isSameDay = (date1, date2) => {
        return (date1.getFullYear() === date2.getFullYear() && date1.getMonth() === date2.getMonth() && date1.getDate() === date2.getDate());
      };
      const getPaymentMethodLabel = (method) => {
        switch (method) {
          case "Cash": return "現金";
          case "BankTransfer": return "轉帳";
          case "LineBank": return "LineBank";
          case "Transfer": return "轉帳"; 
          default: return "其他";
        }
      };

      // --- DEFAULT DATA ---
      const DEFAULT_DATA = { teacherName: "吉他老師", studentName: "學生", credits: 0, lessons: [], payments: [], updatedAt: new Date().toISOString() };

      // --- COMPONENTS ---
      const SettingsModal = ({ isOpen, onClose, data, onUpdateSettings, onImportData }) => {
        const fileInputRef = useRef(null);
        if (!isOpen) return null;
        const exportData = () => {
          const dataStr = JSON.stringify(data, null, 2);
          const blob = new Blob([dataStr], { type: "application/json" });
          const url = URL.createObjectURL(blob);
          const link = document.createElement("a");
          link.href = url;
          link.download = `guitar_class_backup_${new Date().toISOString().slice(0, 10)}.json`;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          URL.revokeObjectURL(url);
        };
        const handleFileUpload = (event) => {
          const file = event.target.files?.[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              const content = e.target?.result;
              const parsed = JSON.parse(content);
              if (parsed.lessons && Array.isArray(parsed.lessons)) {
                if (confirm("確定要匯入此備份檔案？目前的資料將會被覆蓋。")) {
                  onImportData({ ...DEFAULT_DATA, ...parsed });
                  onClose();
                  alert("資料還原成功！");
                }
              } else { alert("檔案格式錯誤，請確認這是正確的備份檔案。"); }
            } catch (err) { alert("無法讀取檔案，請重試。"); }
          };
          reader.readAsText(file);
          if (fileInputRef.current) fileInputRef.current.value = "";
        };
        return (
          <div className="fixed inset-0 bg-slate-900/40 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-in fade-in duration-200">
            <div className="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl">
              <div className="flex justify-between items-center mb-6"><h3 className="text-lg font-bold">設定</h3><button onClick={onClose} className="text-slate-400 hover:text-slate-600"><Icon name="X" size={24} /></button></div>
              <form onSubmit={(e) => { e.preventDefault(); const formData = new FormData(e.currentTarget); onUpdateSettings(formData.get("teacher"), formData.get("student")); }}>
                <div className="space-y-4">
                  <div><label className="block text-sm font-medium text-slate-600 mb-1">老師姓名</label><input name="teacher" defaultValue={data.teacherName} className="w-full p-3 border rounded-xl bg-slate-50 outline-none focus:ring-2 focus:ring-slate-200" /></div>
                  <div><label className="block text-sm font-medium text-slate-600 mb-1">學生姓名</label><input name="student" defaultValue={data.studentName} className="w-full p-3 border rounded-xl bg-slate-50 outline-none focus:ring-2 focus:ring-slate-200" /></div>
                  <div className="pt-2 border-t border-slate-100 mt-4"><h4 className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">資料管理 Data Backup</h4><div className="grid grid-cols-2 gap-3"><button type="button" onClick={exportData} className="flex flex-col items-center justify-center p-3 bg-slate-50 rounded-xl border border-slate-200 hover:bg-slate-100 transition-colors gap-1 text-slate-700"><Icon name="Download" size={18} /><span className="text-xs font-bold">匯出備份</span></button><div className="relative"><input type="file" ref={fileInputRef} accept=".json" onChange={handleFileUpload} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" /><button type="button" className="w-full h-full flex flex-col items-center justify-center p-3 bg-slate-50 rounded-xl border border-slate-200 hover:bg-slate-100 transition-colors gap-1 text-slate-700 pointer-events-none"><Icon name="Upload" size={18} /><span className="text-xs font-bold">匯入還原</span></button></div></div></div>
                  <button type="submit" className="w-full bg-slate-900 text-white py-3 rounded-xl font-bold mt-2">儲存設定</button>
                </div>
              </form>
            </div>
          </div>
        );
      };

      const CheckInModal = ({ isOpen, onClose, checkInDate, setCheckInDate, checkInTime, setCheckInTime, onConfirm }) => {
        if (!isOpen) return null;
        const dateValue = checkInDate ? `${checkInDate.getFullYear()}-${String(checkInDate.getMonth() + 1).padStart(2, '0')}-${String(checkInDate.getDate()).padStart(2, '0')}` : '';
        const handleDateChange = (e) => {
          if (e.target.value) { const [y, m, d] = e.target.value.split('-').map(Number); setCheckInDate(new Date(y, m - 1, d)); }
        };
        return (
          <div className="fixed inset-0 bg-slate-900/40 z-50 flex items-end sm:items-center justify-center sm:p-4 backdrop-blur-sm animate-in fade-in duration-200">
            <div className="bg-white rounded-t-3xl sm:rounded-2xl w-full max-w-sm p-6 shadow-2xl animate-in slide-in-from-bottom-10 sm:slide-in-from-bottom-0">
               <div className="flex justify-between items-center mb-6"><div className="flex items-center gap-2 text-[#4F9D9D]"><Icon name="Clock" size={20} /><h3 className="text-lg font-bold text-slate-800">上課簽到</h3></div><button onClick={onClose} className="p-1 bg-slate-100 rounded-full text-slate-500 hover:bg-slate-200"><Icon name="X" size={18} /></button></div>
              <div className="space-y-6">
                <div><label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-2 block">日期 Date</label><div className="relative"><input type="date" className="w-full h-14 p-3 border rounded-xl bg-slate-50 text-xl font-bold text-center focus:ring-2 focus:ring-[#4F9D9D] outline-none text-slate-800 appearance-none" value={dateValue} onChange={handleDateChange} /></div></div>
                <div><label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-2 block">上課時間 Time</label><div className="relative"><input type="time" className="w-full h-14 p-3 border rounded-xl bg-slate-50 text-xl font-bold text-center focus:ring-2 focus:ring-[#4F9D9D] outline-none text-slate-800 appearance-none" value={checkInTime} onChange={(e) => setCheckInTime(e.target.value)} /></div></div>
                <div className="grid grid-cols-2 gap-3 pt-2"><button onClick={onClose} className="py-3 bg-slate-100 text-slate-600 rounded-xl font-bold hover:bg-slate-200 transition-colors text-sm">取消</button><button onClick={onConfirm} className="py-3 bg-[#4F9D9D] text-white rounded-xl font-bold shadow-lg shadow-[#4F9D9D]/30 active:scale-95 transition-transform text-sm">確認簽到 (-1)</button></div>
              </div>
            </div>
          </div>
        );
      };

      const PaymentModal = ({ isOpen, onClose, payDate, setPayDate, payAmount, setPayAmount, payMethod, setPayMethod, payNote, setPayNote, onConfirm, isDuplicate }) => {
        if (!isOpen) return null;
        return (
          <div className="fixed inset-0 bg-slate-900/40 z-50 flex items-end sm:items-center justify-center sm:p-4 backdrop-blur-sm animate-in fade-in duration-200">
            <div className="bg-white rounded-t-3xl sm:rounded-2xl w-full max-w-sm p-6 shadow-2xl animate-in slide-in-from-bottom-10 sm:slide-in-from-bottom-0">
              <div className="flex justify-between items-center mb-6"><h3 className="text-lg font-bold">紀錄繳費</h3><button onClick={onClose} className="p-1 bg-slate-100 rounded-full text-slate-500 hover:bg-slate-200"><Icon name="X" size={20} /></button></div>
              <div className="space-y-4">
                <div className="grid grid-cols-2 gap-4">
                  <div><label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider">日期 Date</label><div className="relative mt-1"><span className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"><Icon name="Calendar" size={18} /></span><input type="date" className="w-full h-12 pl-10 p-3 border rounded-xl bg-slate-50 text-sm font-bold focus:ring-2 focus:ring-amber-500 outline-none text-slate-800 appearance-none" value={payDate} onChange={(e) => setPayDate(e.target.value)} /></div></div>
                  <div><label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider">金額 Tuition</label><div className="relative mt-1"><span className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 font-bold">$</span><input type="number" inputMode="numeric" className="w-full h-12 pl-8 p-3 border rounded-xl bg-slate-50 text-sm font-bold focus:ring-2 focus:ring-amber-500 outline-none appearance-none" value={payAmount} onChange={(e) => setPayAmount(e.target.value)} /></div></div>
                </div>
                <div><label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider">備註 Note</label><div className="relative mt-1"><span className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"><Icon name="Edit" size={16} /></span><input type="text" placeholder="選填 (Optional)" className="w-full h-12 pl-10 p-3 border rounded-xl bg-slate-50 text-sm font-bold focus:ring-2 focus:ring-amber-500 outline-none text-slate-800 placeholder:font-normal appearance-none" value={payNote} onChange={(e) => setPayNote(e.target.value)} /></div></div>
                <div><label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-2 block">方式 Method</label><div className="grid grid-cols-2 gap-2"><button onClick={() => setPayMethod("Cash")} className={`col-span-2 p-3 rounded-xl border font-bold text-center text-sm transition-all ${payMethod === "Cash" ? "bg-amber-50 border-amber-500 text-amber-700 ring-1 ring-amber-500" : "bg-white border-slate-200 text-slate-400 hover:border-slate-300"}`}>現金 Cash</button><button onClick={() => setPayMethod("BankTransfer")} className={`p-3 rounded-xl border font-bold text-center text-sm transition-all ${payMethod === "BankTransfer" ? "bg-amber-50 border-amber-500 text-amber-700 ring-1 ring-amber-500" : "bg-white border-slate-200 text-slate-400 hover:border-slate-300"}`}>銀行轉帳</button><button onClick={() => setPayMethod("LineBank")} className={`p-3 rounded-xl border font-bold text-center text-sm transition-all ${payMethod === "LineBank" ? "bg-amber-50 border-amber-500 text-amber-700 ring-1 ring-amber-500" : "bg-white border-slate-200 text-slate-400 hover:border-slate-300"}`}>Line Bank</button></div></div>
                <div className="pt-2"><button onClick={onConfirm} disabled={isDuplicate} className={`w-full py-3 rounded-xl font-bold transition-all text-sm ${isDuplicate ? "bg-slate-200 text-slate-400 cursor-not-allowed" : "bg-amber-500 text-white shadow-lg shadow-amber-200 active:scale-95 active:shadow-none"}`}>{isDuplicate ? "本日已繳費" : "確認入帳 (+4 堂)"}</button></div>
              </div>
            </div>
          </div>
        );
      };

      const CalendarView = ({ data, viewDate, setViewDate, onToggleLesson }) => {
        const changeMonth = (offset) => setViewDate(new Date(viewDate.getFullYear(), viewDate.getMonth() + offset, 1));
        const renderCalendar = () => {
          const year = viewDate.getFullYear();
          const month = viewDate.getMonth();
          const daysInMonth = new Date(year, month + 1, 0).getDate();
          const firstDayOfMonth = new Date(year, month, 1).getDay();
          const days = [];
          for (let i = 0; i < firstDayOfMonth; i++) days.push(<div key={`pad-${i}`} className="h-14 bg-slate-50/50 border-t border-r border-slate-100"></div>);
          for (let d = 1; d <= daysInMonth; d++) {
            const currentDay = new Date(year, month, d);
            const isToday = isSameDay(currentDay, new Date());
            const lessonToday = data.lessons.find(l => isSameDay(new Date(l.date), currentDay));
            const paymentsToday = data.payments.filter(p => isSameDay(new Date(p.date), currentDay));
            days.push(
              <button key={`day-${d}`} onClick={() => onToggleLesson(currentDay)} className={`h-14 relative border-t border-r border-slate-100 p-0.5 transition-all flex flex-col items-center justify-start group active:bg-slate-100 ${isToday ? "bg-amber-50" : "hover:bg-slate-50"} ${d === 1 || days.length % 7 === 0 ? "border-l" : ""}`}>
                <div className="w-full flex justify-start pl-0.5"><span className={`text-[10px] font-bold w-4 h-4 flex items-center justify-center rounded-full ${isToday ? "bg-amber-500 text-white" : "text-slate-400"}`}>{d}</span></div>
                <div className="flex flex-col items-center w-full -mt-1">{lessonToday && (<div className="flex flex-col items-center animate-in zoom-in duration-200"><div className="w-4 h-4 rounded-full bg-[#4F9D9D] text-white flex items-center justify-center shadow-sm mb-0"><Icon name="Check" size={10} strokeWidth={3} /></div><span className="text-[10px] font-bold text-slate-400 leading-none tracking-tight scale-90 origin-top mt-0.5">{formatTime(lessonToday.date)}</span></div>)}</div>
                <div className="absolute bottom-0.5 right-0.5 flex flex-col gap-0.5 items-end">{paymentsToday.map(p => (<div key={p.id} className="w-3 h-3 rounded-full bg-amber-100 text-amber-600 flex items-center justify-center border border-amber-200 shadow-sm"><span className="text-[8px] font-bold">$</span></div>))}</div>
                {!lessonToday && !paymentsToday.length && (<div className="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 pointer-events-none mt-2"><Icon name="Plus" size={14} className="text-slate-300" /></div>)}
              </button>
            );
          }
          return days;
        };
        return (
          <div className="bg-white rounded-xl border border-slate-100 shadow-sm overflow-hidden shrink-0">
            <div className="bg-slate-50 px-2 py-1.5 flex items-center justify-between border-b border-slate-100"><div className="font-bold text-xs text-slate-700 flex items-center gap-1.5"><Icon name="Calendar" size={14} className="text-amber-500" />{viewDate.getFullYear()} 年 {viewDate.getMonth() + 1} 月</div><div className="flex gap-0.5"><button onClick={() => changeMonth(-1)} className="p-1 hover:bg-white rounded-md transition-colors text-slate-500"><Icon name="ChevronLeft" size={16} /></button><button onClick={() => setViewDate(new Date())} className="px-2 text-[10px] font-bold text-slate-500 hover:bg-white rounded-md">今天</button><button onClick={() => changeMonth(1)} className="p-1 hover:bg-white rounded-md transition-colors text-slate-500"><Icon name="ChevronRight" size={16} /></button></div></div>
            <div className="grid grid-cols-7 border-b border-slate-100">{["日", "一", "二", "三", "四", "五", "六"].map(d => (<div key={d} className="py-1 text-center text-[10px] font-bold text-slate-400">{d}</div>))}</div>
            <div className="grid grid-cols-7 bg-white">{renderCalendar()}</div>
            <div className="py-1 px-3 bg-slate-50 border-t border-slate-100 text-[10px] font-bold text-slate-400 flex justify-center gap-4"><div className="flex items-center gap-1"><div className="w-3 h-3 rounded-full bg-[#4F9D9D] flex items-center justify-center text-white"><Icon name="Check" size={8} strokeWidth={3} /></div><span>上課</span></div><div className="flex items-center gap-1"><div className="w-2.5 h-2.5 rounded-full bg-amber-100 border border-amber-200 flex items-center justify-center"><span className="text-[7px] text-amber-600 font-bold">$</span></div><span>繳費</span></div></div>
          </div>
        );
      };

      const PaymentHistory = ({ payments, onDeletePayment, onUpdateNote }) => {
        const [editingId, setEditingId] = useState(null);
        const [tempNote, setTempNote] = useState("");

        const startEditing = (p) => {
          setEditingId(p.id);
          setTempNote(p.note || "");
        };

        const saveNote = (id) => {
          onUpdateNote(id, tempNote.trim());
          setEditingId(null);
        };

        const cancelEditing = () => {
          setEditingId(null);
        };

        return (
          <div className="flex-1 min-h-0 flex flex-col bg-white rounded-xl border border-slate-100 shadow-sm overflow-hidden">
            <div className="bg-slate-50 px-3 py-2 border-b border-slate-100 flex justify-between items-center shrink-0">
              <h3 className="font-bold text-slate-700 flex items-center gap-1.5 text-[10px] font-bold uppercase tracking-wider">
                <Icon name="CreditCard" size={12} />繳費紀錄
              </h3>
              <span className="text-[10px] font-bold text-slate-400">點擊備註可修改</span>
            </div>
            <div className="flex-1 overflow-y-auto p-0 scroll-smooth no-scrollbar">
              {payments.length === 0 ? (
                <div className="p-4 text-center text-slate-400 text-[10px] font-bold">尚無繳費紀錄</div>
              ) : (
                payments.map((payment) => (
                  <div key={payment.id} className="px-3 py-3 border-b border-slate-50 last:border-0 flex justify-between items-center group hover:bg-slate-50 transition-colors">
                    <div className="flex-1 flex items-start gap-2 min-w-0">
                      <div className="w-6 h-6 rounded-full bg-amber-50 flex items-center justify-center text-amber-500 shrink-0 mt-0.5">
                        <Icon name="Banknote" size={12} />
                      </div>
                      <div className="flex-1 min-w-0">
                        <div className="font-bold text-slate-800 text-sm leading-none mb-1">{formatCurrency(payment.amount)}</div>
                        <div className="text-[10px] font-bold text-slate-400 leading-none mb-2">
                          {formatDate(payment.date)} • {getPaymentMethodLabel(payment.method)}
                        </div>
                        
                        {editingId === payment.id ? (
                          <div className="flex items-center gap-1 mt-1 animate-in fade-in duration-200">
                            <input 
                              autoFocus 
                              type="text" 
                              value={tempNote} 
                              onChange={(e) => setTempNote(e.target.value)} 
                              onKeyDown={(e) => { 
                                if(e.key==='Enter') saveNote(payment.id); 
                                if(e.key==='Escape') cancelEditing(); 
                              }} 
                              className="flex-1 text-[11px] font-bold text-slate-700 bg-white px-2 py-1 rounded border border-amber-400 outline-none focus:ring-2 focus:ring-amber-500/20" 
                            />
                            <button onClick={() => saveNote(payment.id)} className="p-1 text-emerald-500 hover:bg-emerald-50 rounded"><Icon name="Check" size={16} /></button>
                            <button onClick={cancelEditing} className="p-1 text-slate-400 hover:bg-slate-100 rounded"><Icon name="X" size={16} /></button>
                          </div>
                        ) : (
                          <div 
                            onClick={() => startEditing(payment)} 
                            className="inline-flex items-center gap-1 mt-0.5 cursor-pointer group/note"
                          >
                            {payment.note ? (
                              <div className="text-[11px] font-bold text-slate-500 bg-slate-100 px-2 py-1 rounded hover:bg-slate-200 transition-colors break-all flex items-center gap-1.5">
                                <Icon name="Edit" size={10} className="text-slate-400 shrink-0" />
                                <span>備註: {payment.note}</span>
                              </div>
                            ) : (
                              <div className="text-[10px] font-bold text-slate-300 flex items-center gap-1 hover:text-amber-500 transition-colors border border-dashed border-slate-200 px-2 py-1 rounded">
                                <Icon name="Plus" size={10} /> 新增備註
                              </div>
                            )}
                          </div>
                        )}
                      </div>
                    </div>
                    <div className="flex items-center gap-2 ml-2 shrink-0">
                      <span className="text-[10px] font-black text-emerald-600 bg-emerald-50 px-1.5 py-1 rounded">+4</span>
                      <button onClick={() => onDeletePayment(payment.id)} className="text-slate-200 hover:text-red-400 p-2 transition-colors">
                        <Icon name="Trash2" size={14} />
                      </button>
                    </div>
                  </div>
                ))
              )}
            </div>
          </div>
        );
      };

      const App = () => {
        const [data, setData] = useState(DEFAULT_DATA);
        const [isSettingsOpen, setIsSettingsOpen] = useState(false);
        const [showPayModal, setShowPayModal] = useState(false);
        const [viewDate, setViewDate] = useState(new Date()); 
        const [showCheckInModal, setShowCheckInModal] = useState(false);
        const [checkInDate, setCheckInDate] = useState(null);
        const [checkInTime, setCheckInTime] = useState("");
        const [payAmount, setPayAmount] = useState("2000");
        const [payMethod, setPayMethod] = useState("Cash");
        const [payDate, setPayDate] = useState("");
        const [payNote, setPayNote] = useState("");

        useEffect(() => { 
          const saved = localStorage.getItem("guitarApp_single_v1"); 
          if (saved) { 
            try { 
              setData({ ...DEFAULT_DATA, ...JSON.parse(saved) }); 
            } catch (e) {
              console.error("Failed to parse data", e);
            } 
          } 
        }, []);

        useEffect(() => { 
          localStorage.setItem("guitarApp_single_v1", JSON.stringify(data)); 
        }, [data]);

        const updateSettings = (teacher, student) => { 
          setData(prev => ({ ...prev, teacherName: teacher, studentName: student })); 
          setIsSettingsOpen(false); 
        };

        const handleImportData = (newData) => { 
          setData(newData); 
        };

        const toggleLessonOnDate = (targetDate) => {
          const existingLesson = data.lessons.find(l => isSameDay(new Date(l.date), targetDate));
          if (existingLesson) { 
            setData(prev => ({ ...prev, credits: prev.credits + 1, lessons: prev.lessons.filter(l => l.id !== existingLesson.id) })); 
          } else { 
            setCheckInDate(targetDate); 
            const now = new Date(); 
            setCheckInTime(isSameDay(targetDate, now) ? `${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}` : "19:00"); 
            setShowCheckInModal(true); 
          }
        };

        const confirmCheckIn = () => { 
          if (!checkInDate) return; 
          const [h, m] = checkInTime.split(':').map(Number); 
          const d = new Date(checkInDate); 
          d.setHours(h, m, 0, 0); 
          const iso = d.toISOString(); 
          setData(prev => ({ ...prev, credits: prev.credits - 1, lessons: [{ id: generateId(), date: iso }, ...prev.lessons], updatedAt: iso })); 
          setShowCheckInModal(false); 
        };

        const openPayModal = () => { 
          const d = new Date(); 
          setPayDate(`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`); 
          setPayNote(""); 
          setShowPayModal(true); 
        };

        const recordPayment = () => { 
          if (!payDate) return; 
          const d = new Date(payDate); 
          const now = new Date(); 
          if (isSameDay(d, now)) {
            d.setHours(now.getHours(), now.getMinutes());
          } else {
            d.setHours(12, 0);
          }
          const iso = d.toISOString(); 
          setData(prev => ({ ...prev, credits: prev.credits + 4, payments: [{ id: generateId(), date: iso, amount: Number(payAmount), method: payMethod, note: payNote }, ...prev.payments], updatedAt: iso })); 
          setShowPayModal(false); 
        };

        const deletePayment = (id) => { 
          if(!confirm("確定刪除這條繳費紀錄？點數將會扣除 4 點。")) return; 
          setData(prev => ({ ...prev, credits: prev.credits - 4, payments: prev.payments.filter(p => p.id !== id) })); 
        };

        const updatePaymentNote = (id, newNote) => { 
          setData(prev => ({ ...prev, payments: prev.payments.map(p => p.id === id ? { ...p, note: newNote } : p) })); 
        };

        const isPaymentDuplicate = () => {
          if (!payDate) return false;
          return data.payments.some(p => isSameDay(new Date(p.date), new Date(payDate)));
        };

        const getStatusColor = (c) => c <= 0 ? "bg-red-50 text-red-600 border-red-200" : c === 1 ? "bg-amber-50 text-amber-600 border-amber-200" : "bg-emerald-50 text-emerald-600 border-emerald-200";
        const getStatusMessage = (c) => c <= 0 ? "需繳費" : c === 1 ? "剩1堂" : `剩 ${c} 堂`;

        return (
          <div className="h-screen bg-slate-50 text-slate-800 font-sans overflow-hidden flex flex-col">
            <header className="bg-white px-4 py-2 shrink-0 z-20 shadow-sm border-b border-slate-100 h-[50px] flex items-center">
              <div className="w-full max-w-md mx-auto flex justify-between items-center">
                <div className="flex items-center gap-2 text-slate-800">
                  <div className="bg-amber-500 p-1 rounded-lg text-white"><Icon name="Guitar" size={16} /></div>
                  <h1 className="font-bold text-sm tracking-tight">吉他課簽到</h1>
                </div>
                <button onClick={() => setIsSettingsOpen(true)} className="p-1.5 text-slate-400 hover:text-slate-600 hover:bg-slate-100 rounded-full transition-colors"><Icon name="Settings" size={18} /></button>
              </div>
            </header>
            <main className="flex-1 w-full max-w-md mx-auto p-2 flex flex-col gap-2 min-h-0">
              <div className="bg-white rounded-xl px-3 py-2 shadow-sm border border-slate-100 flex justify-between items-center shrink-0">
                <div className="flex items-center gap-2">
                  <div className="w-6 h-6 rounded-full bg-slate-100 flex items-center justify-center text-slate-500"><Icon name="User" size={14} /></div>
                  <div className="font-bold text-xs text-slate-800">{data.teacherName}</div>
                </div>
                <div className="h-4 w-px bg-slate-100"></div>
                <div className="flex items-center gap-2">
                  <div className="text-right"><div className="font-bold text-xs text-slate-800">{data.studentName}</div></div>
                  <div className="w-6 h-6 rounded-full bg-amber-100 flex items-center justify-center text-amber-600"><Icon name="User" size={14} /></div>
                </div>
              </div>
              <CalendarView data={data} viewDate={viewDate} setViewDate={setViewDate} onToggleLesson={toggleLessonOnDate} />
              <div className="bg-white rounded-xl p-2 px-3 shadow-md shadow-slate-200/50 border border-slate-100 flex items-center justify-between shrink-0 h-14">
                <div className="flex items-center gap-3">
                  <div className="flex items-baseline gap-1">
                    <span className={`text-2xl font-black ${data.credits <= 1 ? "text-amber-500" : "text-slate-800"}`}>{data.credits}</span>
                    <span className="text-xs text-slate-400 font-bold">/ 4</span>
                  </div>
                  <div className={`px-2 py-0.5 rounded-full text-[10px] font-bold border flex items-center gap-1 ${getStatusColor(data.credits)}`}>
                    {getStatusMessage(data.credits)}{data.credits <= 1 && <Icon name="AlertTriangle" size={8} />}
                  </div>
                </div>
                <button onClick={openPayModal} className="flex items-center gap-1.5 px-3 py-1.5 bg-amber-500 text-white rounded-lg active:scale-95 transition-all shadow-md shadow-amber-200 hover:bg-amber-600">
                  <Icon name="Banknote" size={14} /><span className="font-bold text-xs">繳費續期</span>
                </button>
              </div>
              <PaymentHistory payments={data.payments} onDeletePayment={deletePayment} onUpdateNote={updatePaymentNote} />
            </main>
            <CheckInModal isOpen={showCheckInModal} onClose={() => setShowCheckInModal(false)} checkInDate={checkInDate} setCheckInDate={setCheckInDate} checkInTime={checkInTime} setCheckInTime={setCheckInTime} onConfirm={confirmCheckIn} />
            <SettingsModal isOpen={isSettingsOpen} onClose={() => setIsSettingsOpen(false)} data={data} onUpdateSettings={updateSettings} onImportData={handleImportData} />
            <PaymentModal isOpen={showPayModal} onClose={() => setShowPayModal(false)} payDate={payDate} setPayDate={setPayDate} payAmount={payAmount} setPayAmount={setPayAmount} payMethod={payMethod} setPayMethod={setPayMethod} payNote={payNote} setPayNote={setPayNote} onConfirm={recordPayment} isDuplicate={isPaymentDuplicate()} />
          </div>
        );
      };

      const root = createRoot(document.getElementById("root"));
      root.render(<App />);
    </script>
  </body>
</html>
