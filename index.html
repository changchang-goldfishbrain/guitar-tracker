<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    
    <!-- iOS PWA Settings -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="吉他課紀錄">
    <meta name="format-detection" content="telephone=no">
    
    <title>Guitar Class Tracker</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM (UMD) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel (for JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Lucide React Icons (Stable UMD Version) -->
    <script src="https://unpkg.com/lucide-react@0.263.1/dist/umd/lucide-react.min.js"></script>

    <style>
      body {
        background-color: #f8fafc;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        overscroll-behavior-y: none;
        -webkit-tap-highlight-color: transparent;
      }
      .no-scrollbar::-webkit-scrollbar {
        display: none;
      }
      .no-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
      /* Animation Utilities */
      .animate-in {
        animation-duration: 0.2s;
        animation-fill-mode: both;
      }
      .fade-in {
        animation-name: fadeIn;
      }
      .slide-in-from-bottom-10 {
        animation-name: slideInFromBottom10;
      }
      .zoom-in {
        animation-name: zoomIn;
      }
      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }
      @keyframes slideInFromBottom10 {
        from { transform: translateY(2.5rem); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
      }
      @keyframes zoomIn {
        from { transform: scale(0.95); opacity: 0; }
        to { transform: scale(1); opacity: 1; }
      }
    </style>
  <script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "lucide-react": "https://aistudiocdn.com/lucide-react@^0.555.0"
  }
}
</script>
</head>
  <body>
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect, useRef } = React;
      const { createRoot } = ReactDOM;
      
      // --- ICON SETUP ---
      // Fix: Check both window.lucideReact and window.lucide for the library
      const LucideIcons = window.lucideReact || window.lucide || {};
      
      const Icon = ({ name, size = 24, className, ...props }) => {
        const Component = LucideIcons[name];
        if (!Component) {
          // Fallback aliases
          if (name === 'CalendarDays' && LucideIcons['Calendar']) {
             const Fallback = LucideIcons['Calendar'];
             return <Fallback size={size} className={className} {...props} />;
          }
          // Debug fallback
          return <span style={{display:'inline-block', width: size, height: size, background: '#eee'}} title={name}></span>;
        }
        return <Component size={size} className={className} {...props} />;
      };

      // Define icons
      const Guitar = (p) => <Icon name="Guitar" {...p} />;
      const Check = (p) => <Icon name="Check" {...p} />;
      const CalendarIcon = (p) => <Icon name="Calendar" {...p} />;
      const CreditCard = (p) => <Icon name="CreditCard" {...p} />;
      const User = (p) => <Icon name="User" {...p} />;
      const Trash2 = (p) => <Icon name="Trash2" {...p} />;
      const Banknote = (p) => <Icon name="Banknote" {...p} />;
      const Settings = (p) => <Icon name="Settings" {...p} />;
      const X = (p) => <Icon name="X" {...p} />;
      const ChevronLeft = (p) => <Icon name="ChevronLeft" {...p} />;
      const ChevronRight = (p) => <Icon name="ChevronRight" {...p} />;
      const AlertTriangle = (p) => <Icon name="AlertTriangle" {...p} />;
      const Plus = (p) => <Icon name="Plus" {...p} />;
      const Clock = (p) => <Icon name="Clock" {...p} />;
      const Download = (p) => <Icon name="Download" {...p} />;
      const Upload = (p) => <Icon name="Upload" {...p} />;

      // --- UTILS ---
      const generateId = () => Math.random().toString(36).substr(2, 9);

      const formatDate = (dateString) => {
        const date = new Date(dateString);
        return new Intl.DateTimeFormat("zh-TW", {
          month: "numeric",
          day: "numeric",
        }).format(date);
      };

      const formatTime = (dateString) => {
        const date = new Date(dateString);
        return new Intl.DateTimeFormat("zh-TW", {
          hour: "2-digit",
          minute: "2-digit",
          hour12: false,
        }).format(date);
      };

      const formatCurrency = (amount) => {
        return new Intl.NumberFormat("zh-TW", {
          style: "currency",
          currency: "TWD",
          minimumFractionDigits: 0,
        }).format(amount);
      };

      const isSameDay = (date1, date2) => {
        return (
          date1.getFullYear() === date2.getFullYear() &&
          date1.getMonth() === date2.getMonth() &&
          date1.getDate() === date2.getDate()
        );
      };

      const getPaymentMethodLabel = (method) => {
        switch (method) {
          case "Cash": return "現金";
          case "BankTransfer": return "轉帳";
          case "LineBank": return "LineBank";
          case "Transfer": return "轉帳"; 
          default: return "其他";
        }
      };

      // --- DEFAULT DATA ---
      const DEFAULT_DATA = {
        teacherName: "吉他老師",
        studentName: "學生",
        credits: 0,
        lessons: [],
        payments: [],
        updatedAt: new Date().toISOString(),
      };

      // --- COMPONENTS ---

      const SettingsModal = ({ isOpen, onClose, data, onUpdateSettings, onImportData }) => {
        const fileInputRef = useRef(null);
        if (!isOpen) return null;

        const exportData = () => {
          const dataStr = JSON.stringify(data, null, 2);
          const blob = new Blob([dataStr], { type: "application/json" });
          const url = URL.createObjectURL(blob);
          const link = document.createElement("a");
          link.href = url;
          link.download = `guitar_class_backup_${new Date().toISOString().slice(0, 10)}.json`;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          URL.revokeObjectURL(url);
        };

        const handleFileUpload = (event) => {
          const file = event.target.files?.[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              const content = e.target?.result;
              const parsed = JSON.parse(content);
              if (parsed.lessons && Array.isArray(parsed.lessons)) {
                if (confirm("確定要匯入此備份檔案？目前的資料將會被覆蓋。")) {
                  onImportData({ ...DEFAULT_DATA, ...parsed });
                  onClose();
                  alert("資料還原成功！");
                }
              } else {
                alert("檔案格式錯誤，請確認這是正確的備份檔案。");
              }
            } catch (err) {
              alert("無法讀取檔案，請重試。");
            }
          };
          reader.readAsText(file);
          if (fileInputRef.current) fileInputRef.current.value = "";
        };

        return (
          <div className="fixed inset-0 bg-slate-900/40 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-in fade-in duration-200">
            <div className="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl">
              <div className="flex justify-between items-center mb-6">
                <h3 className="text-xl font-bold">設定</h3>
                <button onClick={onClose} className="text-slate-400 hover:text-slate-600">
                  <X size={28} />
                </button>
              </div>
              <form onSubmit={(e) => {
                e.preventDefault();
                const formData = new FormData(e.currentTarget);
                onUpdateSettings(formData.get("teacher"), formData.get("student"));
              }}>
                <div className="space-y-5">
                  <div>
                    <label className="block text-base font-medium text-slate-600 mb-2">老師姓名</label>
                    <input name="teacher" defaultValue={data.teacherName} className="w-full p-3.5 border rounded-xl bg-slate-50 outline-none focus:ring-2 focus:ring-slate-200 text-lg" />
                  </div>
                  <div>
                    <label className="block text-base font-medium text-slate-600 mb-2">學生姓名</label>
                    <input name="student" defaultValue={data.studentName} className="w-full p-3.5 border rounded-xl bg-slate-50 outline-none focus:ring-2 focus:ring-slate-200 text-lg" />
                  </div>
                  <div className="pt-4 border-t border-slate-100 mt-6">
                     <h4 className="text-sm font-bold text-slate-400 uppercase tracking-wider mb-3">資料管理 Data Backup</h4>
                     <div className="grid grid-cols-2 gap-4">
                       <button type="button" onClick={exportData} className="flex flex-col items-center justify-center p-4 bg-slate-50 rounded-xl border border-slate-200 hover:bg-slate-100 transition-colors gap-2 text-slate-700">
                         <Download size={24} />
                         <span className="text-sm font-bold">匯出備份</span>
                       </button>
                       <div className="relative">
                          <input type="file" ref={fileInputRef} accept=".json" onChange={handleFileUpload} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" />
                          <button type="button" className="w-full h-full flex flex-col items-center justify-center p-4 bg-slate-50 rounded-xl border border-slate-200 hover:bg-slate-100 transition-colors gap-2 text-slate-700 pointer-events-none">
                            <Upload size={24} />
                            <span className="text-sm font-bold">匯入還原</span>
                          </button>
                       </div>
                     </div>
                  </div>
                  <button type="submit" className="w-full bg-slate-900 text-white py-4 rounded-xl font-bold mt-4 text-lg">儲存設定</button>
                </div>
              </form>
            </div>
          </div>
        );
      };

      const CheckInModal = ({ isOpen, onClose, checkInDate, checkInTime, setCheckInTime, onConfirm }) => {
        if (!isOpen) return null;
        return (
          <div className="fixed inset-0 bg-slate-900/40 z-50 flex items-end sm:items-center justify-center sm:p-4 backdrop-blur-sm animate-in fade-in duration-200">
            <div className="bg-white rounded-t-3xl sm:rounded-2xl w-full max-w-sm p-6 shadow-2xl animate-in slide-in-from-bottom-10 sm:slide-in-from-bottom-0">
               <div className="flex justify-between items-center mb-6">
                <div className="flex items-center gap-2 text-[#4F9D9D]">
                  <Clock size={24} />
                  <h3 className="text-xl font-bold text-slate-800">上課簽到</h3>
                </div>
                <button onClick={onClose} className="p-2 bg-slate-100 rounded-full text-slate-500 hover:bg-slate-200"><X size={24} /></button>
              </div>
              <div className="space-y-6">
                <div className="bg-slate-50 p-4 rounded-xl text-center">
                   <div className="text-sm text-slate-500 mb-1">日期</div>
                   <div className="text-xl font-bold text-slate-800">
                      {checkInDate?.toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric' })}
                   </div>
                </div>
                <div>
                  <label className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 block">上課時間 Time</label>
                  <input type="time" className="w-full p-4 border rounded-xl bg-slate-50 text-3xl font-bold text-center focus:ring-2 focus:ring-[#4F9D9D] outline-none text-slate-800" value={checkInTime} onChange={(e) => setCheckInTime(e.target.value)} />
                </div>
                <div className="grid grid-cols-2 gap-4 pt-2">
                   <button onClick={onClose} className="py-4 bg-slate-100 text-slate-600 rounded-xl font-bold hover:bg-slate-200 transition-colors text-base">取消</button>
                   <button onClick={onConfirm} className="py-4 bg-[#4F9D9D] text-white rounded-xl font-bold shadow-lg shadow-[#4F9D9D]/30 active:scale-95 transition-transform text-base">確認簽到 (-1)</button>
                </div>
              </div>
            </div>
          </div>
        );
      };

      const PaymentModal = ({ isOpen, onClose, payDate, setPayDate, payAmount, setPayAmount, payMethod, setPayMethod, onConfirm, isDuplicate }) => {
        if (!isOpen) return null;
        return (
          <div className="fixed inset-0 bg-slate-900/40 z-50 flex items-end sm:items-center justify-center sm:p-4 backdrop-blur-sm animate-in fade-in duration-200">
            <div className="bg-white rounded-t-3xl sm:rounded-2xl w-full max-w-sm p-6 shadow-2xl animate-in slide-in-from-bottom-10 sm:slide-in-from-bottom-0">
              <div className="flex justify-between items-center mb-6">
                <h3 className="text-xl font-bold">紀錄繳費</h3>
                <button onClick={onClose} className="p-2 bg-slate-100 rounded-full text-slate-500 hover:bg-slate-200"><X size={24} /></button>
              </div>
              <div className="space-y-5">
                <div>
                  <label className="text-xs font-bold text-slate-400 uppercase tracking-wider">日期 Date</label>
                  <div className="relative mt-2">
                     <span className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"><CalendarIcon size={20} /></span>
                     <input type="date" className="w-full pl-12 p-4 border rounded-xl bg-slate-50 text-lg font-bold focus:ring-2 focus:ring-amber-500 outline-none text-slate-800" value={payDate} onChange={(e) => setPayDate(e.target.value)} />
                  </div>
                </div>
                <div>
                  <label className="text-xs font-bold text-slate-400 uppercase tracking-wider">金額 Tuition</label>
                  <div className="relative mt-2">
                    <span className="absolute left-5 top-1/2 -translate-y-1/2 text-slate-400 font-bold text-lg">$</span>
                    <input type="number" inputMode="numeric" className="w-full pl-10 p-4 border rounded-xl bg-slate-50 text-2xl font-bold focus:ring-2 focus:ring-amber-500 outline-none" value={payAmount} onChange={(e) => setPayAmount(e.target.value)} />
                  </div>
                </div>
                <div>
                  <label className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 block">方式 Method</label>
                  <div className="grid grid-cols-2 gap-3">
                    {["Cash", "BankTransfer", "LineBank"].map(m => (
                      <button key={m} onClick={() => setPayMethod(m)} className={`p-4 rounded-xl border font-bold text-center text-base transition-all ${payMethod === m ? "bg-amber-50 border-amber-500 text-amber-700 ring-1 ring-amber-500" : "bg-white border-slate-200 text-slate-400 hover:border-slate-300"} ${m === "Cash" ? "col-span-2" : ""}`}>
                        {m === "Cash" ? "現金 Cash" : m === "BankTransfer" ? "銀行轉帳" : "Line Bank"}
                      </button>
                    ))}
                  </div>
                </div>
                <div className="pt-2">
                  <button onClick={onConfirm} disabled={isDuplicate} className={`w-full py-4 rounded-xl font-bold transition-all text-base ${isDuplicate ? "bg-slate-200 text-slate-400 cursor-not-allowed" : "bg-amber-500 text-white shadow-lg shadow-amber-200 active:scale-95 active:shadow-none"}`}>{isDuplicate ? "本日已繳費" : "確認入帳 (+4 堂)"}</button>
                </div>
              </div>
            </div>
          </div>
        );
      };

      const CalendarView = ({ data, viewDate, setViewDate, onToggleLesson }) => {
        const changeMonth = (offset) => setViewDate(new Date(viewDate.getFullYear(), viewDate.getMonth() + offset, 1));
        const renderCalendar = () => {
          const year = viewDate.getFullYear();
          const month = viewDate.getMonth();
          const daysInMonth = new Date(year, month + 1, 0).getDate();
          const firstDayOfMonth = new Date(year, month, 1).getDay();
          const days = [];
          for (let i = 0; i < firstDayOfMonth; i++) days.push(<div key={`pad-${i}`} className="h-16 bg-slate-50/50 border-t border-r border-slate-100"></div>);
          for (let d = 1; d <= daysInMonth; d++) {
            const currentDay = new Date(year, month, d);
            const isToday = isSameDay(currentDay, new Date());
            const lessonToday = data.lessons.find(l => isSameDay(new Date(l.date), currentDay));
            const paymentsToday = data.payments.filter(p => isSameDay(new Date(p.date), currentDay));
            days.push(
              <button key={`day-${d}`} onClick={() => onToggleLesson(currentDay)} className={`h-16 relative border-t border-r border-slate-100 p-0.5 transition-all flex flex-col items-center justify-start group active:bg-slate-100 ${isToday ? "bg-amber-50" : "hover:bg-slate-50"} ${d === 1 || days.length % 7 === 0 ? "border-l" : ""}`}>
                <div className="w-full flex justify-start pl-1 pt-1"><span className={`text-xs font-medium w-5 h-5 flex items-center justify-center rounded-full ${isToday ? "bg-amber-500 text-white" : "text-slate-400"}`}>{d}</span></div>
                <div className="flex flex-col items-center w-full -mt-2">{lessonToday && (<div className="flex flex-col items-center animate-in zoom-in duration-200"><div className="w-5 h-5 rounded-full bg-[#4F9D9D] text-white flex items-center justify-center shadow-sm mb-0.5"><Check size={14} strokeWidth={3} /></div><span className="text-[10px] text-slate-400 font-medium leading-none tracking-tight scale-90 origin-top">{formatTime(lessonToday.date)}</span></div>)}</div>
                <div className="absolute bottom-1 right-1 flex flex-col gap-0.5 items-end">{paymentsToday.map(p => (<div key={p.id} className="w-4 h-4 rounded-full bg-amber-100 text-amber-600 flex items-center justify-center border border-amber-200 shadow-sm"><span className="text-[9px] font-bold">$</span></div>))}</div>
                {!lessonToday && !paymentsToday.length && (<div className="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 pointer-events-none mt-2"><Plus size={18} className="text-slate-300" /></div>)}
              </button>
            );
          }
          return days;
        };
        return (
          <div className="bg-white rounded-xl border border-slate-100 shadow-sm overflow-hidden shrink-0">
            <div className="bg-slate-50 px-3 py-3 flex items-center justify-between border-b border-slate-100">
              <div className="font-bold text-base text-slate-700 flex items-center gap-2"><CalendarIcon size={18} className="text-amber-500" />{viewDate.getFullYear()} 年 {viewDate.getMonth() + 1} 月</div>
              <div className="flex gap-1">
                <button onClick={() => changeMonth(-1)} className="p-1.5 hover:bg-white rounded-md transition-colors text-slate-500"><ChevronLeft size={20} /></button>
                <button onClick={() => setViewDate(new Date())} className="px-3 text-sm font-bold text-slate-500 hover:bg-white rounded-md">今天</button>
                <button onClick={() => changeMonth(1)} className="p-1.5 hover:bg-white rounded-md transition-colors text-slate-500"><ChevronRight size={20} /></button>
              </div>
            </div>
            <div className="grid grid-cols-7 border-b border-slate-100">{["日", "一", "二", "三", "四", "五", "六"].map(d => (<div key={d} className="py-2 text-center text-xs font-bold text-slate-400">{d}</div>))}</div>
            <div className="grid grid-cols-7 bg-white">{renderCalendar()}</div>
            <div className="py-2 px-4 bg-slate-50 border-t border-slate-100 text-xs text-slate-400 flex justify-center gap-6">
              <div className="flex items-center gap-1.5"><div className="w-4 h-4 rounded-full bg-[#4F9D9D] flex items-center justify-center text-white"><Check size={10} strokeWidth={3} /></div><span>上課</span></div>
              <div className="flex items-center gap-1.5"><div className="w-4 h-4 rounded-full bg-amber-100 border border-amber-200 flex items-center justify-center"><span className="text-[9px] text-amber-600 font-bold">$</span></div><span>繳費</span></div>
            </div>
          </div>
        );
      };

      const PaymentHistory = ({ payments, onDeletePayment }) => {
        return (
          <div className="flex-1 min-h-0 flex flex-col bg-white rounded-xl border border-slate-100 shadow-sm overflow-hidden">
            <div className="bg-slate-50 px-4 py-3 border-b border-slate-100 flex justify-between items-center shrink-0">
               <h3 className="font-bold text-slate-700 flex items-center gap-2 text-sm uppercase tracking-wider"><CreditCard size={16} />繳費紀錄</h3>
               <span className="text-xs text-slate-400">捲動查看</span>
            </div>
            <div className="overflow-y-auto p-0 scroll-smooth">
              {payments.length === 0 ? (<div className="p-6 text-center text-slate-400 text-xs">尚無繳費紀錄</div>) : (
                payments.map((payment) => (
                  <div key={payment.id} className="px-4 py-3 border-b border-slate-50 last:border-0 flex justify-between items-center group hover:bg-slate-50 transition-colors">
                    <div className="flex items-center gap-3">
                      <div className="w-8 h-8 rounded-full bg-amber-50 flex items-center justify-center text-amber-500 shrink-0"><Banknote size={16} /></div>
                      <div>
                        <div className="font-bold text-slate-800 text-base leading-none mb-1">{formatCurrency(payment.amount)}</div>
                        <div className="text-xs text-slate-400 leading-none">{formatDate(payment.date)} • {getPaymentMethodLabel(payment.method)}</div>
                      </div>
                    </div>
                    <div className="flex items-center gap-2">
                        <span className="text-xs font-bold text-emerald-600 bg-emerald-50 px-1.5 py-0.5 rounded">+4</span>
                        <button onClick={() => onDeletePayment(payment.id)} className="text-slate-300 hover:text-red-400 p-2"><Trash2 size={16} /></button>
                    </div>
                  </div>
                ))
              )}
            </div>
          </div>
        );
      };

      const App = () => {
        const [data, setData] = useState(DEFAULT_DATA);
        const [isSettingsOpen, setIsSettingsOpen] = useState(false);
        const [showPayModal, setShowPayModal] = useState(false);
        const [viewDate, setViewDate] = useState(new Date()); 
        const [showCheckInModal, setShowCheckInModal] = useState(false);
        const [checkInDate, setCheckInDate] = useState(null);
        const [checkInTime, setCheckInTime] = useState("");
        const [payAmount, setPayAmount] = useState("2000");
        const [payMethod, setPayMethod] = useState("Cash");
        const [payDate, setPayDate] = useState("");

        useEffect(() => {
          const saved = localStorage.getItem("guitarApp_single_v1");
          if (saved) { try { setData({ ...DEFAULT_DATA, ...JSON.parse(saved) }); } catch (e) {} }
        }, []);
        useEffect(() => { localStorage.setItem("guitarApp_single_v1", JSON.stringify(data)); }, [data]);

        const updateSettings = (teacher, student) => { setData(prev => ({ ...prev, teacherName: teacher, studentName: student })); setIsSettingsOpen(false); };
        const handleImportData = (newData) => { setData(newData); };
        const toggleLessonOnDate = (targetDate) => {
          const existingLesson = data.lessons.find(l => isSameDay(new Date(l.date), targetDate));
          if (existingLesson) {
            setData(prev => ({ ...prev, credits: prev.credits + 1, lessons: prev.lessons.filter(l => l.id !== existingLesson.id) }));
          } else {
            setCheckInDate(targetDate);
            const now = new Date();
            setCheckInTime(isSameDay(targetDate, now) ? `${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}` : "19:00");
            setShowCheckInModal(true);
          }
        };
        const confirmCheckIn = () => {
          if (!checkInDate) return;
          const [h, m] = checkInTime.split(':').map(Number);
          const d = new Date(checkInDate); d.setHours(h, m, 0, 0);
          const iso = d.toISOString();
          setData(prev => ({ ...prev, credits: prev.credits - 1, lessons: [{ id: generateId(), date: iso }, ...prev.lessons], updatedAt: iso }));
          setShowCheckInModal(false);
        };
        const openPayModal = () => {
          const d = new Date();
          setPayDate(`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`);
          setShowPayModal(true);
        };
        const recordPayment = () => {
          if (!payDate) return;
          const d = new Date(payDate);
          const now = new Date();
          isSameDay(d, now) ? d.setHours(now.getHours(), now.getMinutes()) : d.setHours(12, 0);
          const iso = d.toISOString();
          setData(prev => ({ ...prev, credits: prev.credits + 4, payments: [{ id: generateId(), date: iso, amount: Number(payAmount), method: payMethod }, ...prev.payments], updatedAt: iso }));
          setShowPayModal(false);
        };
        const deletePayment = (id) => {
          if(!confirm("確定刪除這條繳費紀錄？點數將會扣除 4 點。")) return;
          setData(prev => ({ ...prev, credits: prev.credits - 4, payments: prev.payments.filter(p => p.id !== id) }));
        };
        const isPaymentDuplicate = () => data.payments.some(p => isSameDay(new Date(p.date), new Date(payDate)));
        const getStatusColor = (c) => c <= 0 ? "bg-red-50 text-red-600 border-red-200" : c === 1 ? "bg-amber-50 text-amber-600 border-amber-200" : "bg-emerald-50 text-emerald-600 border-emerald-200";

        return (
          <div className="h-screen bg-slate-50 text-slate-800 font-sans overflow-hidden flex flex-col">
            <header className="bg-white px-5 py-3 shrink-0 z-20 shadow-sm border-b border-slate-100 h-[64px] flex items-center">
              <div className="w-full max-w-md mx-auto flex justify-between items-center">
                <div className="flex items-center gap-3 text-slate-800"><div className="bg-amber-500 p-1.5 rounded-xl text-white"><Guitar size={24} /></div><h1 className="font-bold text-xl tracking-tight">吉他課簽到</h1></div>
                <button onClick={() => setIsSettingsOpen(true)} className="p-2 text-slate-400 hover:text-slate-600 hover:bg-slate-100 rounded-full transition-colors"><Settings size={28} /></button>
              </div>
            </header>
            <main className="flex-1 w-full max-w-md mx-auto p-3 flex flex-col gap-3 min-h-0">
              <div className="bg-white rounded-xl px-4 py-3 shadow-sm border border-slate-100 flex justify-between items-center shrink-0">
                <div className="flex items-center gap-3"><div className="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-500"><User size={20} /></div><div className="font-bold text-base text-slate-800">{data.teacherName}</div></div>
                <div className="h-6 w-px bg-slate-100"></div>
                <div className="flex items-center gap-3"><div className="text-right"><div className="font-bold text-base text-slate-800">{data.studentName}</div></div><div className="w-8 h-8 rounded-full bg-amber-100 flex items-center justify-center text-amber-600"><User size={20} /></div></div>
              </div>
              <CalendarView data={data} viewDate={viewDate} setViewDate={setViewDate} onToggleLesson={toggleLessonOnDate} />
              <div className="bg-white rounded-xl p-3 px-4 shadow-md shadow-slate-200/50 border border-slate-100 flex items-center justify-between shrink-0 h-20">
                <div className="flex items-center gap-4">
                    <div className="flex items-baseline gap-1.5"><span className={`text-4xl font-black ${data.credits <= 1 ? "text-amber-500" : "text-slate-800"}`}>{data.credits}</span><span className="text-base text-slate-400 font-bold">/ 4</span></div>
                    <div className={`px-3 py-1 rounded-full text-sm font-bold border flex items-center gap-1.5 ${getStatusColor(data.credits)}`}>{data.credits <= 0 ? "需繳費" : data.credits === 1 ? "剩1堂" : `剩 ${data.credits} 堂`}{data.credits <= 1 && <AlertTriangle size={14} />}</div>
                </div>
                <button onClick={openPayModal} className="flex items-center gap-2 px-4 py-2.5 bg-amber-500 text-white rounded-xl active:scale-95 transition-all shadow-md shadow-amber-200 hover:bg-amber-600"><Banknote size={18} /><span className="font-bold text-base">繳費續期</span></button>
              </div>
              <PaymentHistory payments={data.payments} onDeletePayment={deletePayment} />
            </main>
            <CheckInModal isOpen={showCheckInModal} onClose={() => setShowCheckInModal(false)} checkInDate={checkInDate} checkInTime={checkInTime} setCheckInTime={setCheckInTime} onConfirm={confirmCheckIn} />
            <SettingsModal isOpen={isSettingsOpen} onClose={() => setIsSettingsOpen(false)} data={data} onUpdateSettings={updateSettings} onImportData={handleImportData} />
            <PaymentModal isOpen={showPayModal} onClose={() => setShowPayModal(false)} payDate={payDate} setPayDate={setPayDate} payAmount={payAmount} setPayAmount={setPayAmount} payMethod={payMethod} setPayMethod={setPayMethod} onConfirm={recordPayment} isDuplicate={isPaymentDuplicate()} />
          </div>
        );
      };

      const root = createRoot(document.getElementById("root"));
      root.render(<App />);
    </script>
  </body>
</html>